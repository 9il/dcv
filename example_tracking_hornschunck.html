<h1 id="horn-schunck-optical-flow-example">Horn-Schunck Optical Flow Example</h1>
<p>This example demonstrates usage of Pyramidal Horn-Schunck optical flow algorithm implementation in DCV library.</p>
<h2 id="modules-used">Modules used</h2>
<ul>
<li>dcv.core</li>
<li>dcv.io</li>
<li>dcv.imgproc.imgmanip</li>
<li>dcv.tracking.opticalflow</li>
<li>dcv.plot.opticalflow</li>
</ul>
<h2 id="example-description">Example description</h2>
<p>In this example, optical flow benchmark data set from <a href="http://vision.middlebury.edu/flow/data/">Middlebury University’s website</a> is used to demonstrate the algorithm results. Some of this data is present in the <a href="https://github.com/ljubobratovicrelja/dcv/tree/master/examples/data/optflow">library’s example data directory</a>.</p>
<p>For simple demonstaration, let’s take the <strong>Army</strong> image pair from Middlebury:</p>
<img src="https://github.com/ljubobratovicrelja/dcv/blob/master/examples/data/optflow/Army/frame10.png?raw=true" alt="alt tag" />
<p>The Horn-Schunck properties are stored in the <code>HornSchunckProperties</code> structure. Here is the chunck of code where those are initialized:</p>
<div ><pre style="margin: 0; line-height: 125%"><span style="color: #008000">// Setup algorithm parameters.</span>
HornSchunckProperties props = HornSchunckProperties();
props.iterationCount = args.length &gt;= 4 ? args[3].to!<span style="color: #2b91af">int</span> : 100;
props.alpha = args.length &gt;= 5 ? args[4].to!<span style="color: #2b91af">float</span> : 10.0f;
props.gaussSigma = args.length &gt;= 6 ? args[5].to!<span style="color: #2b91af">float</span> : 1.0f;
props.gaussKernelSize = args.length &gt;= 7 ? args[6].to!<span style="color: #2b91af">uint</span> : 3;

<span style="color: #2b91af">uint</span> pyramidLevels = args.length &gt;= 8 ? args[7].to!<span style="color: #2b91af">int</span> : 3;
</pre></div>

<p>Following chunck of code initializes the Optical Flow algorithm objects, and calls the flow evaluation:</p>
<div ><pre style="margin: 0; line-height: 125%">HornSchunckFlow hsFlow = <span style="color: #0000ff">new</span> HornSchunckFlow(props);
DensePyramidFlow densePyramid = <span style="color: #0000ff">new</span> DensePyramidFlow(hsFlow, pyramidLevels); 

<span style="color: #0000ff">auto</span> flow = densePyramid.evaluate(current, next);
</pre></div>

<p>Returning value <code>flow</code> is of type Slice!(3, float*), as matrix of float[2] (uv, or xy) displacement values. In the following chucnk, we color-code this displacement map by using <code>dcv.plot.opticalflow.colorCode</code> function, and also use it to warp the <code>current</code> image by use of <code>dcv.imgproc.imgmanip.warp</code> function, so we can nicely visualize the success rate of the computed flow values:</p>
<div ><pre style="margin: 0; line-height: 125%"><span style="color: #0000ff">auto</span> flowColor = flow.colorCode;
<span style="color: #0000ff">auto</span> flowWarp = current.sliced.warp(flow);
</pre></div>
<p>Here is the color code of computed flow for <em>Army</em> images:</p>
<div class="figure">
<img src="https://github.com/ljubobratovicrelja/dcv/blob/master/examples/tracking/hornschunck/result/2_flowColor.png?raw=true" alt="alt tag" />
</div>
<p>And lastly we write out these images in following order:</p>
<div ><pre style="margin: 0; line-height: 125%">current.imwrite(<span style="color: #a31515">&quot;./result/1_current.png?raw=true&quot;</span>);
flowColor.imwrite(ImageFormat.IF_RGB, <span style="color: #a31515">&quot;./result/2_flowColor.png?raw=true&quot;</span>);
flowWarp.imwrite(ImageFormat.IF_MONO, <span style="color: #a31515">&quot;./result/3_flowWarp.png?raw=true&quot;</span>);
next.imwrite(<span style="color: #a31515">&quot;./result/4_next.png?raw=true&quot;</span>);
</pre></div>
<p>Images are written in this order to help you inspect them in ordinary image viewer application. Assuming that files in your directory are sorted by name, you could switch easily between warped image and target (next) image, and see clearly the difference between the original and computed (warped) one.</p>
<h2 id="example-program">Example Program</h2>
<p>Please refer to example program’s help for more info (./hornschunck -h).</p>
<p><span><big>Note:</big></span><br>
Currently only 8-bit mono images are supported in the <code>HornSchunckFlow</code> implementation. This will be resolved in future to support RGB images in 16, and 32 bit depth.</p>
<span><big>Complete code:</big></span>
<div ><pre style="margin: 0; line-height: 125%"><span style="color: #0000ff">module</span> dcv.example.opticalflow;

<span style="color: #008000">/** </span>
<span style="color: #008000"> * Dense optical flow example, by using </span>
<span style="color: #008000"> * pyramidal Horn-Schunck implementation in dcv.</span>
<span style="color: #008000"> */</span>

<span style="color: #0000ff">import</span> std.stdio;
<span style="color: #0000ff">import</span> std.conv : to;
<span style="color: #0000ff">import</span> std.experimental.ndslice;

<span style="color: #0000ff">import</span> dcv.core;
<span style="color: #0000ff">import</span> dcv.io;

<span style="color: #0000ff">import</span> dcv.imgproc.imgmanip : warp;
<span style="color: #0000ff">import</span> dcv.tracking.opticalflow : HornSchunckFlow, 
    HornSchunckProperties, DensePyramidFlow;
<span style="color: #0000ff">import</span> dcv.plot.opticalflow : colorCode;


<span style="color: #2b91af">void</span> printHelp() {
    writeln( <span style="color: #a31515">`</span>
<span style="color: #a31515">DCV Optical DenseFlow example.</span>
<span style="color: #a31515">If only one parameter is given it is considered to be</span>
<span style="color: #a31515">the name of the subfolder of the data/optflow directory.</span>
<span style="color: #a31515">These directories represent the benchmark dataset from the</span>
<span style="color: #a31515">Middlebury University website: http://vision.middlebury.edu/flow/data/</span>
<span style="color: #a31515">Example:</span>
<span style="color: #a31515">./hornschunck Army</span>
<span style="color: #a31515">Note:</span>
<span style="color: #a31515">This mode will use default parameters (described in the following section).</span>
<span style="color: #a31515">If multiple parameters are given, then parameters are considered to be:</span>
<span style="color: #a31515">1 - path to current frame image; [../data/optflow/Army/frame10.png?raw=true]</span>
<span style="color: #a31515">2 - path to next frame image; [../data/optflow/Army/frame11.png?raw=true]</span>
<span style="color: #a31515">3 - optical flow iteration count; [100]</span>
<span style="color: #a31515">4 - Horn-Schunck flow smoothness strength parameter; [10.0]</span>
<span style="color: #a31515">5 - Gaussian image smoothing theta parameter; [1.0]</span>
<span style="color: #a31515">6 - Gaussian kernel size; [3]</span>
<span style="color: #a31515">7 - optical flow pyramid level count; [3]</span>
<span style="color: #a31515">Example:</span>
<span style="color: #a31515">./hornschunck ../../data/optflow/Evergreen/frame10.png?raw=true ../../data/optflow/Evergreen/frame11.png?raw=true 300 25 3 5 4</span>
<span style="color: #a31515">... which will compute the optical flow for given two images, </span>
<span style="color: #a31515">by 300 iteration at each pyramid level, by using value of 25.0 </span>
<span style="color: #a31515">as smoothness strenght, in 4 pyramid levels. Images are smoothed</span>
<span style="color: #a31515">with gaussian filter with sigma value 3.0, sized 5x5.</span>
<span style="color: #a31515">        `</span>);
}

<span style="color: #2b91af">void</span> main(string [] args) {

    <span style="color: #0000ff">if</span> (args.length == 2 &amp;&amp; args[1] == <span style="color: #a31515">&quot;-h&quot;</span>) {
        printHelp();
        <span style="color: #0000ff">return</span>;
    }

    <span style="color: #008000">// Read source images.</span>
    <span style="color: #0000ff">auto</span> rparams = ReadParams(ImageFormat.IF_MONO, BitDepth.BD_8);

    string currentPath, nextPath;

    <span style="color: #0000ff">if</span> (args.length == 2) {
        currentPath = <span style="color: #a31515">&quot;../../data/optflow/&quot;</span> ~ args[1] ~ <span style="color: #a31515">&quot;/frame10.png?raw=true&quot;</span>;
        nextPath = <span style="color: #a31515">&quot;../../data/optflow/&quot;</span> ~ args[1] ~ <span style="color: #a31515">&quot;/frame11.png?raw=true&quot;</span>;
    } <span style="color: #0000ff">else</span> {
        currentPath = args.length &gt;= 2 ? args[1] : <span style="color: #a31515">&quot;../../data/optflow/Army/frame10.png?raw=true&quot;</span>;
        nextPath = args.length &gt;= 3 ? args[2] : <span style="color: #a31515">&quot;../../data/optflow/Army/frame11.png?raw=true&quot;</span>;
    }

    <span style="color: #0000ff">auto</span> current = imread(currentPath, rparams);
    <span style="color: #0000ff">auto</span> next = imread(nextPath, rparams);

    <span style="color: #008000">// Setup algorithm parameters.</span>
    HornSchunckProperties props = HornSchunckProperties();
    props.iterationCount = args.length &gt;= 4 ? args[3].to!<span style="color: #2b91af">int</span> : 100;
    props.alpha = args.length &gt;= 5 ? args[4].to!<span style="color: #2b91af">float</span> : 10.0f;
    props.gaussSigma = args.length &gt;= 6 ? args[5].to!<span style="color: #2b91af">float</span> : 1.0f;
    props.gaussKernelSize = args.length &gt;= 7 ? args[6].to!<span style="color: #2b91af">uint</span> : 3;

    <span style="color: #2b91af">uint</span> pyramidLevels = args.length &gt;= 8 ? args[7].to!<span style="color: #2b91af">int</span> : 3;

    HornSchunckFlow hsFlow = <span style="color: #0000ff">new</span> HornSchunckFlow(props);
    DensePyramidFlow densePyramid = <span style="color: #0000ff">new</span> DensePyramidFlow(hsFlow, pyramidLevels); 

    <span style="color: #0000ff">auto</span> flow = densePyramid.evaluate(current, next);

    <span style="color: #0000ff">auto</span> flowColor = flow.colorCode;
    <span style="color: #0000ff">auto</span> flowWarp = current.sliced.warp(flow);

    current.imwrite(<span style="color: #a31515">&quot;./result/1_current.png?raw=true&quot;</span>);
    flowColor.imwrite(ImageFormat.IF_RGB, <span style="color: #a31515">&quot;./result/2_flowColor.png?raw=true&quot;</span>);
    flowWarp.imwrite(ImageFormat.IF_MONO, <span style="color: #a31515">&quot;./result/3_flowWarp.png?raw=true&quot;</span>);
    next.imwrite(<span style="color: #a31515">&quot;./result/4_next.png&quot;</span>);
}
</pre></div>
