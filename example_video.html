
<h1 id="video-reading-example">Video Reading Example</h1>
<p>This example should demonstrate how read video files using dcv library.</p>
<h2 id="modules-used">Modules used</h2>
<ul>
<li>dcv.core</li>
<li>dcv.imgproc.color</li>
<li>dcv.io</li>
</ul>
<h2 id="disclaimer">Disclaimer</h2>
<p>Video streaming utilities are still heavily a wip. This is merely a preview of what I think these utilities should look like. I’ve stopped working on these modules for now, and will continue in time. If anyone has a suggestion how we could make these utilities more effective, you’re more than welcome to help me!</p>
<h2 id="demo-application">Demo Application</h2>
<p>In this example, video streaming is demonstrated using the demo application, built using GtkD GUI toolkit. Here is a screen Grab of the Demo Video Player running on my system:</p>
<div class="figure">
<img src="https://github.com/ljubobratovicrelja/dcv/blob/master/examples/video/result/screengrab_1.png?raw=true" alt="alt tag" />
</div>
<h3 id="inputstream-usage">InputStream usage</h3>
<p>Input video streaming utility is located in the dcv.io.video.input module, defined as InputStream class. In the demo application, we’ve defined a custom gtk.DrawingArea, which is used as a video (frame) canvas. Note that this implementation is simplified for the demonstration purpose - the stream is allocated and opened in our frame canvas. Also, the queue timer for the next frame draw is also installed here. The video stream is opened in the Canvas constructor:</p>
<div ><pre style="margin: 0; line-height: 125%"><span style="color: #0000ff">this</span>(<span style="color: #0000ff">in</span> string videoFile) {
    stream = <span style="color: #0000ff">new</span> InputStream; <span style="color: #008000">// initialize the stream</span>
    stream.open(videoFile, InputStreamType.FILE); <span style="color: #008000">// open the file with given path.</span>

    <span style="color: #0000ff">if</span> (!stream.isOpen) {
        exit(-1);
    }
    <span style="color: #008000">// ...</span>
}
</pre></div>
<p>The <code>VideoStreamCanvas.redraw</code> method will try to grab next frame of the video, and show it on the canvas. The frame grabbing part is defined in the first part of the method:</p>
<div ><pre style="margin: 0; line-height: 125%"><span style="color: #008000">// Reading frame image.</span>
Image image = <span style="color: #0000ff">null</span>; 

<span style="color: #008000">// Create timer, if not already been created. It&#39;ll repeat the frame reading operation in correct time.</span>
<span style="color: #0000ff">if</span> ( timeout <span style="color: #0000ff">is</span> <span style="color: #0000ff">null</span> ) {
    timeout = <span style="color: #0000ff">new</span> Timeout( 1000 / <span style="color: #0000ff">cast</span>(<span style="color: #2b91af">int</span>)(stream.frameRate ? stream.frameRate : 25), &amp;queueNextFrame, <span style="color: #0000ff">false</span> );
}

<span style="color: #008000">// Read the frame - exit if theres no more frames.</span>
<span style="color: #0000ff">if</span> (!stream.readFrame(image) || image <span style="color: #0000ff">is</span> <span style="color: #0000ff">null</span>) {
    exit(0);
} 
</pre></div>
<h3 id="more-examples">More examples</h3>
<p>For more extensive example, please take a look into a unit test in the dcv.io.video module (source/dcv/io/video.package.d file). This is actually a functional test proving the video streaming utilities work as expected. Please keep in mind that these modules are not done yet, and will surely change in future.</p>

<br><span><big>Complete code:</big></span>
<div ><pre style="margin: 0; line-height: 125%"><span style="color: #0000ff">module</span> dcv.example.video.app;

<span style="color: #008000">/** </span>
<span style="color: #008000"> * Video i/o example using dcv library.</span>
<span style="color: #008000"> */</span>

<span style="color: #0000ff">import</span> dcv.example.video.gui;

<span style="color: #0000ff">import</span> std.stdio;

<span style="color: #0000ff">import</span> gtk.Main;


<span style="color: #2b91af">void</span> main(string [] args) {

	<span style="color: #008000">// set default video if invalid argument set is given.</span>
	<span style="color: #0000ff">if</span> (args.length != 2) {
		args = [args[0], <span style="color: #a31515">&quot;../data/centaur_1.mpg&quot;</span>];
	}

	Main.init(args);

	VideoPlayer player = <span style="color: #0000ff">new</span> VideoPlayer(args);
	player.show();

	Main.run();
}
</pre></div>
<br>
<div ><pre style="margin: 0; line-height: 125%"><span style="color: #0000ff">module</span> dcv.example.video.gui;


<span style="color: #0000ff">import</span> std.stdio;
<span style="color: #0000ff">import</span> std.c.stdlib : exit;

<span style="color: #0000ff">import</span> gtk.Widget;
<span style="color: #0000ff">import</span> gtk.DrawingArea;
<span style="color: #0000ff">import</span> gtk.MainWindow;

<span style="color: #0000ff">import</span> gdk.Event;

<span style="color: #0000ff">import</span> glib.Timeout;

<span style="color: #0000ff">import</span> cairo.ImageSurface;
<span style="color: #0000ff">import</span> cairo.Context;

<span style="color: #0000ff">import</span> dcv.io.image;
<span style="color: #0000ff">import</span> dcv.imgproc.color;
<span style="color: #0000ff">import</span> dcv.core.utils;
<span style="color: #0000ff">import</span> dcv.io.video;


<span style="color: #008000">/**</span>
<span style="color: #008000"> * Video stream canvas.</span>
<span style="color: #008000"> * </span>
<span style="color: #008000"> * Most basic implementation which demonstrates</span>
<span style="color: #008000"> * how to open the video stream from video, grab it&#39;s frames</span>
<span style="color: #008000"> * and show them on the screen using GtkD GUI library.</span>
<span style="color: #008000"> */</span>
<span style="color: #0000ff">class</span> VideoStreamCanvas : DrawingArea {


	<span style="color: #0000ff">private</span> InputStream stream = <span style="color: #0000ff">null</span>; <span style="color: #008000">// video stream object.</span>
	<span style="color: #0000ff">private</span> Timeout timeout = <span style="color: #0000ff">null</span>; <span style="color: #008000">// timeout used to queue next frame grab</span>


	<span style="color: #0000ff">this</span>(<span style="color: #0000ff">in</span> string videoFile) {
		stream = <span style="color: #0000ff">new</span> InputStream; <span style="color: #008000">// initialize the stream</span>
		stream.open(videoFile, InputStreamType.FILE); <span style="color: #008000">// open the file with given path.</span>

		<span style="color: #0000ff">if</span> (!stream.isOpen) {
			exit(-1);
		}

		addOnDraw(&amp;redraw);
	}

	<span style="color: #2b91af">bool</span> redraw(Scoped!Context cr, Widget widget) {

		<span style="color: #008000">// Reading frame image.</span>
		Image image = <span style="color: #0000ff">null</span>; 

		<span style="color: #008000">// Create timer, if not already been created. It&#39;ll repeat the frame reading operation in correct time.</span>

		<span style="color: #0000ff">if</span> ( timeout <span style="color: #0000ff">is</span> <span style="color: #0000ff">null</span> ) {
			timeout = <span style="color: #0000ff">new</span> Timeout( 1000 / <span style="color: #0000ff">cast</span>(<span style="color: #2b91af">int</span>)(stream.frameRate ? stream.frameRate : 25), &amp;queueNextFrame, <span style="color: #0000ff">false</span> );
		}

		<span style="color: #008000">// Read the frame - exit if theres no more frames.</span>

		<span style="color: #0000ff">if</span> (!stream.readFrame(image) || image <span style="color: #0000ff">is</span> <span style="color: #0000ff">null</span>) {
			exit(0);
		} 

		<span style="color: #008000">// If the video is yuv, as the example video actually is, convert it to rgb.</span>

		<span style="color: #0000ff">if</span> (image.format == ImageFormat.IF_YUV) {
			<span style="color: #0000ff">auto</span> rgb = image.sliced.yuv2rgb;
			image = rgb.asImage(ImageFormat.IF_RGB);
		}

		<span style="color: #008000">// Create ImageSurface object from the frame data</span>

		<span style="color: #2b91af">int</span> w = <span style="color: #0000ff">cast</span>(<span style="color: #2b91af">int</span>)image.width;
		<span style="color: #2b91af">int</span> h = <span style="color: #0000ff">cast</span>(<span style="color: #2b91af">int</span>)image.height;
		<span style="color: #2b91af">int</span> r = w*3;

		<span style="color: #0000ff">auto</span> imsurface = ImageSurface.create(CairoFormat.RGB24, w, h);
		<span style="color: #0000ff">auto</span> imsurfaceData = imsurface.getData();
		<span style="color: #0000ff">auto</span> imdata = image.data;
		<span style="color: #2b91af">int</span> rowStride = w*4;

		<span style="color: #0000ff">foreach</span>(row; 0..h) {
			<span style="color: #0000ff">foreach</span>(col; 0..w) {
				<span style="color: #0000ff">foreach</span>(channel; 0..3) {
					imsurfaceData[row*rowStride + col*4 + channel] = imdata[row*w*3 + col*3 + channel];
				}
			}
		}

		<span style="color: #008000">// Draw the ImageSurface object to the screen.</span>

		cr.setSourceSurface(imsurface, 0, 0);
		cr.paint();
		queueDrawArea(0, 0, w, h);
		setSizeRequest(w, h);

		<span style="color: #008000">// Release the image surface memory</span>

		imsurface.destroy();

		<span style="color: #0000ff">return</span> <span style="color: #0000ff">true</span>;
	}

	<span style="color: #2b91af">bool</span> queueNextFrame() {
		GtkAllocation area;
		getAllocation(area);
		
		queueDrawArea(area.x, area.y, area.width, area.height);
		
		<span style="color: #0000ff">return</span> <span style="color: #0000ff">true</span>;
	}
}

<span style="color: #008000">/**</span>
<span style="color: #008000"> * Video player utility window.</span>
<span style="color: #008000"> * </span>
<span style="color: #008000"> */</span>
<span style="color: #0000ff">class</span> VideoPlayer : MainWindow {
	VideoStreamCanvas videoCanvas;
	<span style="color: #0000ff">this</span>(string [] args) { 
		<span style="color: #0000ff">super</span>(<span style="color: #a31515">&quot;DCV-GtkD Video Player&quot;</span>); 

		<span style="color: #008000">// Create the canvas, assuming first argument in the program is the video file on the file system.</span>
		videoCanvas = <span style="color: #0000ff">new</span> VideoStreamCanvas(args[1]);
		add(videoCanvas);
		videoCanvas.show();

		<span style="color: #008000">// Add the exit signal on &#39;q&#39; keypress.</span>
		addOnKeyPress (<span style="color: #0000ff">delegate</span> <span style="color: #2b91af">bool</span>(Event event, Widget width) {
				<span style="color: #0000ff">auto</span> v = <span style="color: #0000ff">cast</span>(<span style="color: #2b91af">char</span>)event.key.keyval;
				<span style="color: #0000ff">if</span> (v == <span style="color: #a31515">&#39;q&#39;</span> || v == <span style="color: #a31515">&#39;Q&#39;</span>)
					std.c.stdlib.exit(0);
				<span style="color: #0000ff">return</span> <span style="color: #0000ff">true</span>;
			});
	}
}
</pre></div>
